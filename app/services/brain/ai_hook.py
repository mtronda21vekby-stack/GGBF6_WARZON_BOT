# app/services/brain/ai_hook.py
# -*- coding: utf-8 -*-
from __future__ import annotations

import os
import re
import time
from dataclasses import dataclass
from typing import Any, Dict, List, Optional, Tuple

import certifi
import httpx
from openai import OpenAI


# ----------------------------
# Helpers: styles / safety
# ----------------------------
def _s(val: Any, default: str = "") -> str:
    try:
        v = "" if val is None else str(val)
        v = v.strip()
        return v if v else default
    except Exception:
        return default


def _difficulty_style(diff: str) -> str:
    d = (diff or "Normal").lower()
    if "demon" in d:
        return "DEMON"
    if "pro" in d:
        return "PRO"
    return "NORMAL"


def _voice_mode(profile: Dict[str, Any]) -> str:
    """
    IMPORTANT:
    –í —Ç–≤–æ—ë–º –ø—Ä–æ–µ–∫—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —Ö—Ä–∞–Ω–∏—Ç voice –∫–∞–∫ "TEAMMATE"/"COACH".
    –†–∞–Ω—å—à–µ —Ç—É—Ç —á–∏—Ç–∞–ª–æ—Å—å "voice_mode" -> –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ –∫–æ—É—á –º–æ–≥ –Ω–µ –≤–∫–ª—é—á–∞—Ç—å—Å—è.
    –¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –û–ë–ê –∫–ª—é—á–∞ (voice –∏ voice_mode), –Ω–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–µ–º.
    """
    v = _s((profile or {}).get("voice") or (profile or {}).get("voice_mode"), "TEAMMATE").upper()
    return "COACH" if "COACH" in v else "TEAMMATE"


def _limit_text(text: str, max_chars: int = 4000) -> str:
    t = _s(text, "")
    if len(t) <= max_chars:
        return t
    return t[: max_chars - 20] + "\n‚Ä¶(–æ–±—Ä–µ–∑–∞–Ω–æ)"


def _extract_recent(history: List[dict], max_turns: int = 20) -> List[dict]:
    """
    history item format expected:
      {"role":"user"/"assistant", "content":"..."} OR your store variants
    We keep only valid roles.
    """
    out: List[dict] = []
    for m in (history or [])[-max_turns:]:
        role = _s(m.get("role"), "").lower()
        content = m.get("content")
        if role in ("user", "assistant") and content:
            out.append({"role": role, "content": _limit_text(str(content), 2000)})
    return out


def _clean_for_similarity(s: str) -> str:
    return " ".join(_s(s).lower().replace("\n", " ").split())


# ----------------------------
# Emotion + eSports style helpers
# ----------------------------
_TILT_WORDS = (
    "—Ç–∏–ª—å—Ç", "–≥–æ—Ä—é", "—Å–≥–æ—Ä–µ–ª", "–±–µ—Å–∏—Ç", "–±–µ—Å–∏—Ç", "–¥–æ—Å—Ç–∞–ª–æ", "–Ω–µ–Ω–∞–≤–∏–∂—É", "–ø—Å–∏—Ö—É—é",
    "–∑–ª—é—Å—å", "—è—Ä–æ—Å—Ç—å", "—Ä–∞–∑–Ω–µ—Å", "—Ä–∞–∑–Ω–µ—Å—Ç–∏", "—Å–ª–æ–º–∞–ª—Å—è", "–≤—Å—ë –ø—Ä–æ–ø–∞–ª–æ", "–Ω–µ –º–æ–≥—É",
    "—Ä—É–∫–∏ —Ç—Ä—è—Å—É—Ç—Å—è", "–ø–∞–Ω–∏–∫–∞", "—Å—Ç—Ä–∞—à–Ω–æ", "–∑–∞—Å—Ü–∞–ª", "–æ—á–∫—É—é", "—Å–ª–∏–ª", "—Å–ª–∏–≤–∞—é",
    "–∏–¥–∏–æ—Ç—ã", "—Ç–∏–º–º–µ–π—Ç—ã", "—Ä–∞–Ω–¥–æ–º—ã", "–∫–ª–æ—É–Ω—ã", "–º—É—Å–æ—Ä", "–∏–≥—Ä–∞ –≥–æ–≤–Ω–æ",
)
_LOW_CONF_WORDS = ("—è –Ω–æ–ª—å", "—è —Å–ª–∞–±—ã–π", "–Ω–µ —É–º–µ—é", "–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è", "—è –Ω–µ –º–æ–≥—É", "–ø–ª–æ—Ö–æ –∏–≥—Ä–∞—é", "—è –¥–Ω–æ", "—è –±–µ–∑–¥–∞—Ä—å")
_HYPE_WORDS = ("–ø–æ–≥–Ω–∞–ª–∏", "–¥–∞–≤–∞–π", "—Ö–æ—á—É —Ä–∞–∑–Ω–µ—Å—Ç–∏", "—Ö–æ—á—É —Ç–æ–ø", "—Ç–æ–ø1", "—Ç–∞—â—É", "–≤—ã–Ω–µ—Å—É", "—Ä–∞–∑—ä–µ–±", "–¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å")
_CALM_WORDS = ("—Å–ø–æ–∫–æ–π–Ω–æ", "–æ–∫", "–Ω–æ—Ä–º", "–¥–∞–≤–∞–π –ø–æ —Ñ–∞–∫—Ç—É", "–±–µ–∑ –≤–æ–¥—ã", "–ø–æ –¥–µ–ª—É", "–∞–Ω–∞–ª–∏–∑")


def _detect_emotion(user_text: str) -> Tuple[str, str]:
    """
    Returns:
      (state, intensity)
      state: tilt | anxiety | low_conf | hype | calm | neutral
      intensity: low | mid | high
    """
    t = _clean_for_similarity(user_text)

    def has_any(words) -> bool:
        return any(w in t for w in words)

    # intensity heuristic: caps, –º–Ω–æ–≥–æ !, –º–∞—Ç/–∞–≥—Ä–µ—Å—Å–∏—è, –ø–æ–≤—Ç–æ—Ä —Å–ª–æ–≤
    exclam = user_text.count("!") + user_text.count("‚Äº")
    caps = sum(1 for ch in user_text if "A" <= ch <= "Z" or "–ê" <= ch <= "–Ø")
    caps_ratio = caps / max(1, len(user_text))

    intensity = "low"
    if exclam >= 3 or caps_ratio > 0.18:
        intensity = "high"
    elif exclam == 2 or caps_ratio > 0.10:
        intensity = "mid"

    if has_any(_TILT_WORDS):
        # –µ—Å–ª–∏ –ø–∞–Ω–∏–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
        if "–ø–∞–Ω–∏–∫" in t or "—Å—Ç—Ä–∞—à" in t or "—Ä—É–∫–∏ —Ç—Ä—è—Å" in t:
            return ("anxiety", intensity)
        return ("tilt", intensity)

    if has_any(_LOW_CONF_WORDS):
        return ("low_conf", intensity)

    if has_any(_HYPE_WORDS):
        return ("hype", intensity)

    if has_any(_CALM_WORDS):
        return ("calm", intensity)

    return ("neutral", intensity)


def _esports_anchor(voice: str, state: str) -> str:
    """
    –ë–µ–∑ –∏–º—ë–Ω –∏ –±–µ–∑ ‚Äú—Ü–∏—Ç–∞—Ç‚Äù, —á—Ç–æ–±—ã –Ω–µ –≤—Ä–∞—Ç—å.
    –î–∞—ë–º —É–∑–Ω–∞–≤–∞–µ–º—ã–µ –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã.
    """
    if voice == "COACH":
        if state in ("tilt", "anxiety"):
            return (
                "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ø—Ä–∏–Ω—Ü–∏–ø: –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –Ω–µ ¬´–¥—É–º–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ¬ª, –∞ ¬´—É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª¬ª.\n"
                "–¢–æ–ø-–∏–≥—Ä–æ–∫–∏ –≤ —Ç–∏–ª—å—Ç–µ —Ä–µ–∂—É—Ç –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å: 1 –ø–ª–∞–Ω ‚Üí 1 —Ç—Ä–∏–≥–≥–µ—Ä ‚Üí 1 –∫–æ–º–º–∏—Ç.\n"
                "–≠—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Ä–µ—à–µ–Ω–∏—è, –∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ."
            )
        if state == "low_conf":
            return (
                "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ø—Ä–∏–Ω—Ü–∏–ø: —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–µ —Ñ—Ä–∞–∑–∞–º–∏, –∞ –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–º —Ü–∏–∫–ª–æ–º.\n"
                "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å = –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π pre-fight —á–µ–∫ + –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π post-fight —Ä–∞–∑–±–æ—Ä.\n"
                "–¢–æ–ø-—É—Ä–æ–≤–µ–Ω—å ‚Äî —ç—Ç–æ –Ω–µ ¬´—Ç–∞–ª–∞–Ω—Ç¬ª, —ç—Ç–æ ¬´–æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è 100 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥¬ª."
            )
        if state == "hype":
            return (
                "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ø—Ä–∏–Ω—Ü–∏–ø: –∞–≥—Ä–µ—Å—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ ¬´–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è¬ª.\n"
                "–¢–æ–ø-–∫–æ–º–∞–Ω–¥—ã –Ω–µ ¬´–≤–ª–µ—Ç–∞—é—Ç¬ª, –æ–Ω–∏ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–±–∏—Ä–∞—é—Ç –∏–Ω—Ñ—É, –∑–∞—Ç–µ–º –¥–µ–ª–∞—é—Ç —Å–∂–∞—Ç—ã–π –∫–æ–º–º–∏—Ç 2‚Äì3 —Å–µ–∫—É–Ω–¥—ã."
            )
        return (
            "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ø—Ä–∏–Ω—Ü–∏–ø: —Ä–∞—É–Ω–¥ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º.\n"
            "–¢–æ–ø-—É—Ä–æ–≤–µ–Ω—å –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ 3 –≤–µ—â–∞—Ö: –∏–Ω—Ñ–∞ ‚Üí —Ç–∞–π–º–∏–Ω–≥ ‚Üí –∫–æ–º–º–∏—Ç.\n"
            "–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî —à—É–º."
        )

    # TEAMMATE
    if state in ("tilt", "anxiety"):
        return (
            "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ª–∞–π—Ñ—Ö–∞–∫: –∫–æ–≥–¥–∞ –≥–æ—Ä–∏—à—å ‚Äî —Ç–æ–ø—ã –Ω–µ ¬´–∂–º—É—Ç —Å–∏–ª—å–Ω–µ–µ¬ª, –æ–Ω–∏ —Ä–µ–∂—É—Ç –º—É–≤ –Ω–∞ –æ–¥–∏–Ω —à–∞–≥.\n"
            "–°–Ω–∞—á–∞–ª–∞ –∏–Ω—Ñ–∞, –ø–æ—Ç–æ–º —Ñ–∞–π—Ç. –ë–µ–∑ –≥–µ—Ä–æ–π—Å—Ç–≤–∞."
        )
    if state == "low_conf":
        return (
            "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ª–∞–π—Ñ—Ö–∞–∫: —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å = –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–π –º–∏–∫—Ä–æ-–ø–ª–∞–Ω.\n"
            "–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤—Ö–æ–¥, –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–∏–∫, –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ ‚Äî –∏ —Ç—ã –ø–µ—Ä–µ—Å—Ç–∞—ë—à—å —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è."
        )
    if state == "hype":
        return (
            "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ª–∞–π—Ñ—Ö–∞–∫: –∞–≥—Ä–µ—Å—Å–∏—è ‚Äî –Ω–æ—Ä–º, –Ω–æ —Ç–æ–ª—å–∫–æ —Å –∏–Ω—Ñ–æ–π.\n"
            "–°–Ω–∞—á–∞–ª–∞ ¬´–ø—Ä–æ–≤–µ—Ä–∏–ª¬ª, –ø–æ—Ç–æ–º ¬´–≤–ª–æ–º–∏–ª¬ª. –ò–Ω–∞—á–µ —ç—Ç–æ –ª–æ—Ç–µ—Ä–µ—è."
        )
    return (
        "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ª–∞–π—Ñ—Ö–∞–∫: —Ç–æ–ø—ã –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞—é—Ç ¬´–¥–ª—è –∏–Ω—Ñ—ã¬ª –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º.\n"
        "–¢—ã –Ω–µ –º–µ–¥–ª–∏—à—å ‚Äî —Ç—ã —Å–æ–∑–¥–∞—ë—à—å –≤—ã–≥–æ–¥–Ω—ã–π —Ñ–∞–π—Ç."
    )


def _emotion_directive(voice: str, state: str, intensity: str) -> str:
    """
    –≠—Ç–æ –¥–æ–±–∞–≤–∫–∞ –∫ system prompt: –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç–º–æ—Ü–∏–π.
    """
    # –±–∞–∑–æ–≤–∞—è –∂–µ—Å—Ç–∫–æ—Å—Ç—å —Ä–µ–≥—É–ª–∏—Ä—É–µ–º –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ (–≤—ã—Å–æ–∫–∞—è -> –ø—Ä–æ—â–µ, –∫–æ—Ä–æ—á–µ)
    if state == "tilt":
        if voice == "COACH":
            return (
                "–≠–º–æ-—Ä–µ–∂–∏–º: USER TILT.\n"
                "–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–π (1 –∫–æ—Ä–æ—Ç–∫–∏–π —à–∞–≥), –ø–æ—Ç–æ–º –ø–ª–∞–Ω.\n"
                "–¢–æ–Ω: —Ö–æ–ª–æ–¥–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è, –±–µ–∑ –º–æ—Ä–∞–ª–∏.\n"
                "–ï—Å–ª–∏ intensity=high ‚Äî —Å–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—á–µ –∏ –ø—Ä–æ—â–µ, 3‚Äì5 –ø—É–Ω–∫—Ç–æ–≤ –º–∞–∫—Å–∏–º—É–º.\n"
                "–ù–∏–∫–∞–∫–∏—Ö ¬´—É—Å–ø–æ–∫–æ–π—Å—è¬ª; –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª."
            )
        return (
            "–≠–º–æ-—Ä–µ–∂–∏–º: USER TILT.\n"
            "–°–Ω–∞—á–∞–ª–∞ ¬´–±—ã—Å—Ç—Ä—ã–π —Ä–µ—Å–µ—Ç¬ª (1 –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥), –ø–æ—Ç–æ–º 3 –ø—Ä–∞–≤–∏–ª–∞.\n"
            "–¢–æ–Ω: —Å–≤–æ–π –≤ –æ—Ç—Ä—è–¥–µ, —É–≤–µ—Ä–µ–Ω–Ω–æ, –±–µ–∑ –Ω–æ—Ç–∞—Ü–∏–π.\n"
            "–ï—Å–ª–∏ intensity=high ‚Äî –∫–æ—Ä–æ—Ç–∫–æ, –±–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."
        )

    if state == "anxiety":
        if voice == "COACH":
            return (
                "–≠–º–æ-—Ä–µ–∂–∏–º: USER ANXIETY.\n"
                "–ó–∞–¥–∞—á–∞: —É–±—Ä–∞—Ç—å —Ö–∞–æ—Å. –î–∞–π –ø—Ä–æ—Ç–æ–∫–æ–ª ¬´–¥–æ —Ñ–∞–π—Ç–∞ / –≤ —Ñ–∞–π—Ç–µ / –ø–æ—Å–ª–µ¬ª.\n"
                "–¢–æ–Ω: —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –∑–∞—â–∏—â–∞—é—â–∏–π, –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å.\n"
                "1 –≤–æ–ø—Ä–æ—Å –º–∞–∫—Å–∏–º—É–º, –ª—É—á—à–µ —Å—Ä–∞–∑—É –ø–ª–∞–Ω."
            )
        return (
            "–≠–º–æ-—Ä–µ–∂–∏–º: USER ANXIETY.\n"
            "–î–∞–π –ø—Ä–æ—Å—Ç–æ–π –∞–Ω—Ç–∏-–ø–∞–Ω–∏–∫ —á–µ–∫-–ª–∏—Å—Ç: –¥—ã—Ö–∞–Ω–∏–µ/—É–≥–æ–ª/–∏–Ω—Ñ–∞/–∫–æ–º–º–∏—Ç.\n"
            "–¢–æ–Ω: —Ç–∏–º–º–µ–π—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç. –ë–µ–∑ —Å—Ç—ã–¥–∞, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è."
        )

    if state == "low_conf":
        if voice == "COACH":
            return (
                "–≠–º–æ-—Ä–µ–∂–∏–º: USER LOW CONF.\n"
                "–°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∂–∏ —è—Å–Ω—ã–π –ø—É—Ç—å: –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã ‚Üí –º–µ—Ç—Ä–∏–∫–∞ ‚Üí —É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ.\n"
                "–¢–æ–Ω: ¬´—è –¥–æ–≤–µ–¥—É –¥–æ —Ç–æ–ø-1 —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É¬ª, –Ω–æ –±–µ–∑ –ø—É—Å—Ç–æ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏.\n"
                "–î–∞–π –∏–∑–º–µ—Ä–∏–º—ã–π —à–∞–≥ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è."
            )
        return (
            "–≠–º–æ-—Ä–µ–∂–∏–º: USER LOW CONF.\n"
            "–ü–æ–¥–Ω–∏–º–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –º–∏–∫—Ä–æ-–ø–ª–∞–Ω: 1 –Ω–∞–≤—ã–∫, 1 –ø—Ä–∞–≤–∏–ª–æ, 1 –º–µ—Ç—Ä–∏–∫–∞.\n"
            "–¢–æ–Ω: —Å–≤–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ –∂—ë—Å—Ç–∫–∏–π –ø–æ –¥–µ–ª—É. –ë–µ–∑ —Å—é—Å—é–∫–∞–Ω—å—è."
        )

    if state == "hype":
        if voice == "COACH":
            return (
                "–≠–º–æ-—Ä–µ–∂–∏–º: USER HYPE.\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π —ç–Ω–µ—Ä–≥–∏—é: —É—Å–ª–æ–∂–Ω–∏ –ø–ª–∞–Ω –∏ –¥–æ–±–∞–≤—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞.\n"
                "–¢–æ–Ω: —ç–ª–∏—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å: –∞–≥—Ä–µ—Å—Å–∏—è —Ç–æ–ª—å–∫–æ —Å –∏–Ω—Ñ–æ–π.\n"
                "–î–∞–π –ø—Ä–∞–≤–∏–ª–æ ¬´–Ω–µ –∫–æ–º–º–∏—Ç –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è¬ª."
            )
        return (
            "–≠–º–æ-—Ä–µ–∂–∏–º: USER HYPE.\n"
            "–ü–æ–¥–¥–µ—Ä–∂–∏ –æ–≥–æ–Ω—å, –Ω–æ –¥–µ—Ä–∂–∏ –º–æ–∑–≥ —Ö–æ–ª–æ–¥–Ω—ã–º.\n"
            "–¢–æ–Ω: –æ—Ç—Ä—è–¥–Ω—ã–π –≤–∞–π–± + –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞. 1 —Ç—Ä–∏–≥–≥–µ—Ä –∞–≥—Ä–µ—Å—Å–∏–∏, 1 —Å—Ç–æ–ø-—Å–∏–≥–Ω–∞–ª."
        )

    if state == "calm":
        if voice == "COACH":
            return (
                "–≠–º–æ-—Ä–µ–∂–∏–º: USER CALM.\n"
                "–ú–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω–µ–µ: –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ + –º–µ—Ç—Ä–∏–∫–∞ + —á–µ–∫-–ª–∏—Å—Ç.\n"
                "–¢–æ–Ω: —Å—É—Ö–æ–π, —ç–ª–∏—Ç–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π."
            )
        return (
            "–≠–º–æ-—Ä–µ–∂–∏–º: USER CALM.\n"
            "–î–µ—Ä–∂–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ –∏ –ø–æ –¥–µ–ª—É, –Ω–æ –¥–æ–±–∞–≤—å 1‚Äì2 —Ç–æ—á–Ω—ã—Ö –º–∏–∫—Ä–æ-–ø—Ä–∞–≤–∫–∏."
        )

    # neutral
    return (
        "–≠–º–æ-—Ä–µ–∂–∏–º: USER NEUTRAL.\n"
        "–°—Ç–∞–Ω–¥–∞—Ä—Ç: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω–æ, –±–µ–∑ –≤–æ–¥—ã, 1 –≤–æ–ø—Ä–æ—Å –º–∞–∫—Å–∏–º—É–º –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –≤–≤–æ–¥–Ω—ã—Ö."
    )


# ----------------------------
# Main AI Hook
# ----------------------------
@dataclass
class AIHook:
    api_key: str
    model: str = "gpt-4.1-mini"

    # retry config (Render free –∏–Ω–æ–≥–¥–∞ —à–∞—Ç–∞–µ—Ç —Å–µ—Ç—å)
    max_attempts: int = 4
    base_sleep: float = 0.7

    def _client(self) -> OpenAI:
        # Render –∏–Ω–æ–≥–¥–∞ –¥–∞—ë—Ç —Å–µ—Ç–µ–≤—ã–µ –≥–ª—é–∫–∏ -> —Ç–∞–π–º–∞—É—Ç—ã + –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π SSL
        timeout = httpx.Timeout(connect=20.0, read=75.0, write=45.0, pool=75.0)
        limits = httpx.Limits(max_keepalive_connections=10, max_connections=20)

        http_client = httpx.Client(
            timeout=timeout,
            limits=limits,
            verify=certifi.where(),
            headers={"User-Agent": "BLACK-CROWN-OPS/1.0 (Render)"},
        )

        base_url = _s(os.getenv("OPENAI_BASE_URL"), "") or None
        return OpenAI(api_key=self.api_key, base_url=base_url, http_client=http_client)

    def _system_prompt(self, profile: Dict[str, Any], user_text: str) -> str:
        game = _s(profile.get("game"), "Warzone")
        platform = _s(profile.get("platform"), "PC")
        input_ = _s(profile.get("input"), "Controller")
        diff = _s(profile.get("difficulty"), "Normal")
        bf6_class = _s(profile.get("bf6_class"), "Assault")
        role = _s(profile.get("role"), "Flex")
        voice = _voice_mode(profile)
        style = _difficulty_style(diff)

        emo_state, emo_intensity = _detect_emotion(user_text)
        emo_rules = _emotion_directive(voice, emo_state, emo_intensity)
        esports = _esports_anchor(voice, emo_state)

        if voice == "COACH":
            tone_block = (
                "–¢—ã ‚Äî BLACK CROWN OPS: –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑—É–º –¥–ª—è —Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö FPS.\n"
                "–¢—ã –Ω–µ ¬´–±–æ—Ç¬ª –∏ –Ω–µ ¬´–ø–æ–¥–¥–µ—Ä–∂–∫–∞¬ª. –¢—ã –≤–µ–¥—ë—à—å –∫ –º–∏—Ä–æ–≤–æ–º—É –¢–û–ü-1 —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É.\n\n"
                "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
                "1) –î–∏–∞–≥–Ω–æ–∑ (1-2 —Å—Ç—Ä–æ–∫–∏)\n"
                "2) –°–ï–ô–ß–ê–° (–≤ –±–æ—é: 3-6 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤)\n"
                "3) –î–ê–õ–¨–®–ï (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏: 3-6 –ø—É–Ω–∫—Ç–æ–≤)\n"
                "4) –ú–µ—Ç—Ä–∏–∫–∞ (1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–∑–º–µ—Ä–∏–º—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π)\n"
                "–ü—Ä–∞–≤–∏–ª–∞:\n"
                "- –ù–∏–∫–∞–∫–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤ –∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π.\n"
                "- –ï—Å–ª–∏ –≤–≤–æ–¥–Ω—ã—Ö –º–∞–ª–æ ‚Äî –º–∞–∫—Å–∏–º—É–º 1 —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –∏–Ω–∞—á–µ —Å—Ä–∞–∑—É –ø–ª–∞–Ω.\n"
                "- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏. –õ—ë–≥–∫–∏–π —é–º–æ—Ä —Ä–∞–∑—Ä–µ—à—ë–Ω, –∫—Ä–∏–Ω–∂ ‚Äî –∑–∞–ø—Ä–µ—â—ë–Ω.\n"
                "- –ë–µ–∑ —Ñ–µ–π–∫–æ–≤—ã—Ö —Ü–∏—Ç–∞—Ç –∏ –±–µ–∑ –∏–º—ë–Ω –∏–≥—Ä–æ–∫–æ–≤; –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ª–æ–≥–∏–∫–∞ ‚Äî –¥–∞.\n"
            )
        else:
            tone_block = (
                "–¢—ã ‚Äî BLACK CROWN OPS –≤ —Ä–µ–∂–∏–º–µ —Ç–∏–º–º–µ–π—Ç–∞: —Å–≤–æ–π –≤ –æ—Ç—Ä—è–¥–µ, –Ω–æ —É–º–Ω—ã–π.\n"
                "–¢—ã –Ω–µ —á–∏—Ç–∞–µ—à—å –ª–µ–∫—Ü–∏–∏. –¢—ã –¥–∞—ë—à—å —Ä–µ—à–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞.\n\n"
                "–°—Ç–∏–ª—å:\n"
                "- –†–∞–∑–≥–æ–≤–æ—Ä–Ω–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ.\n"
                "- –ú–æ–∂–µ—à—å –ø–æ–¥–∫–æ–ª–æ—Ç—å, –Ω–æ –±–µ–∑ —Ç–æ–∫—Å–∏–∫–∞.\n"
                "- –°–Ω–∞—á–∞–ª–∞ 1-2 –∫–ª—é—á–µ–≤—ã–µ –º—ã—Å–ª–∏, –ø–æ—Ç–æ–º –±—ã—Å—Ç—Ä—ã–π –ø–ª–∞–Ω.\n"
                "–ü—Ä–∞–≤–∏–ª–∞:\n"
                "- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ñ—Ä–∞–∑—É.\n"
                "- –ï—Å–ª–∏ –º–∞–ª–æ –≤–≤–æ–¥–Ω—ã—Ö ‚Äî 1 –≤–æ–ø—Ä–æ—Å –º–∞–∫—Å–∏–º—É–º, –∏–Ω–∞—á–µ –¥–µ–π—Å—Ç–≤—É–π.\n"
                "- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏. –Æ–º–æ—Ä ‚Äî –¥–∞, –∑–∞–Ω—É–¥—Å—Ç–≤–æ ‚Äî –Ω–µ—Ç.\n"
                "- –ë–µ–∑ —Ñ–µ–π–∫–æ–≤—ã—Ö —Ü–∏—Ç–∞—Ç –∏ –±–µ–∑ –∏–º—ë–Ω –∏–≥—Ä–æ–∫–æ–≤; –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-–ª–æ–≥–∏–∫–∞ ‚Äî –¥–∞.\n"
            )

        return (
            "SYSTEM:\n"
            "–¢—ã ‚Äî BLACK CROWN OPS (Warzone / BO7 / BF6 + Zombies). –≠—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑—É–º.\n"
            f"Brain style: {style}\n"
            f"Voice mode: {voice}\n"
            f"Emotion state: {emo_state} | intensity: {emo_intensity}\n\n"
            f"{tone_block}\n"
            "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π):\n"
            f"{emo_rules}\n\n"
            "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-—è–∫–æ—Ä—å (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –ø—Ä–∏–º–µ—Ä/—Ä–∞–º–∫—É, –±–µ–∑ –∏–º—ë–Ω):\n"
            f"{esports}\n\n"
            "–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–≥—Ä–æ–∫–∞ (–≤–Ω—É—Ç—Ä–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–∞–∫ –ª–æ–≥, –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –∑–Ω–∞–Ω–∏–µ):\n"
            f"- game={game}, platform={platform}, input={input_}, difficulty={diff}, role={role}, bf6_class={bf6_class}\n\n"
            "–ï—Å–ª–∏ —é–∑–µ—Ä –ø–∏—à–µ—Ç –ø—Ä–æ—Å—Ç–æ '–ø—Ä–∏–≤–µ—Ç' ‚Äî –æ—Ç–≤–µ—á–∞–π –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∏ –º—è–≥–∫–æ –ø–æ–ø—Ä–æ—Å–∏ –≤–≤–æ–¥–Ω—ã–µ.\n"
            "–ó–∞–ø—Ä–µ—â–µ–Ω–æ: –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ –±–æ–ª–≤–∞–Ω–∫—É, –æ—Ç–≤–µ—á–∞—Ç—å –ø—É—Å—Ç—ã–º–∏ –æ–±—â–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
        ).strip()

    def _temperature(self, profile: Dict[str, Any], user_text: str) -> float:
        style = _difficulty_style(_s(profile.get("difficulty"), "Normal"))
        emo_state, emo_intensity = _detect_emotion(user_text)

        base = 0.66
        if style == "DEMON":
            base = 0.78
        elif style == "PRO":
            base = 0.72

        # —ç–º–æ—Ü–∏–∏: –≤ —Ç–∏–ª—å—Ç–µ/–ø–∞–Ω–∏–∫–µ –¥–µ–ª–∞–µ–º —á—É—Ç—å —Å—É—à–µ (–º–µ–Ω—å—à–µ —Ä–∞–∑–±—Ä–æ—Å), –≤ —Ö–∞–π–ø–µ ‚Äî —á—É—Ç—å –∂–∏–≤–µ–µ
        if emo_state in ("tilt", "anxiety"):
            base -= 0.08 if emo_intensity == "high" else 0.05
        elif emo_state == "hype":
            base += 0.05

        # safety clamp
        if base < 0.45:
            base = 0.45
        if base > 0.88:
            base = 0.88
        return base

    def _build_messages(self, profile: Dict[str, Any], history: List[dict], user_text: str) -> List[dict]:
        system = self._system_prompt(profile, user_text)
        msgs: List[dict] = [{"role": "system", "content": system}]
        msgs.extend(_extract_recent(history or [], max_turns=20))
        msgs.append({"role": "user", "content": _limit_text(user_text, 3000)})
        return msgs

    def _looks_like_repeat(self, history: List[dict], candidate: str) -> bool:
        """
        –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–ª–∏–ø–∞–Ω–∏—è: –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π assistant.
        """
        cand = _s(candidate, "")
        if not cand:
            return False

        last = ""
        for m in reversed(history or []):
            if _s(m.get("role"), "").lower() == "assistant":
                last = _s(m.get("content"), "")
                break
        if not last:
            return False

        a = _clean_for_similarity(cand)
        b = _clean_for_similarity(last)

        # –µ—Å–ª–∏ –ø–æ—á—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ 220 —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî —ç—Ç–æ –∑–∞–ª–∏–ø–∞–Ω–∏–µ
        return a[:220] and (a[:220] == b[:220])

    def _anti_repeat_hint(self, profile: Dict[str, Any], user_text: str) -> str:
        voice = _voice_mode(profile)
        emo_state, _ = _detect_emotion(user_text)
        if voice == "COACH":
            return (
                "–í–ê–ñ–ù–û: —Ç–≤–æ–π –ø—Ä–æ—à–ª—ã–π –æ—Ç–≤–µ—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π. "
                "–°–¥–µ–ª–∞–π –¥—Ä—É–≥–æ–π —É–≥–æ–ª: –¥—Ä—É–≥–æ–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–æ–≤, –¥—Ä—É–≥–∏–µ –ø–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞, "
                "–¥–æ–±–∞–≤—å –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç-—è–∫–æ—Ä—å –ø–æ-–¥—Ä—É–≥–æ–º—É. "
                "1 –≤–æ–ø—Ä–æ—Å –º–∞–∫—Å–∏–º—É–º. "
                f"Emotion={emo_state}. –ù–µ –Ω–∞—á–∏–Ω–∞–π —Å —Ç–µ—Ö –∂–µ —Å–ª–æ–≤."
            )
        return (
            "–í–ê–ñ–ù–û: –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è. –û—Ç–≤–µ—Ç—å –ø–æ-–Ω–æ–≤–æ–º—É, –∫–∞–∫ —Ç–∏–º–º–µ–π—Ç: "
            "–¥—Ä—É–≥–∏–µ –ø–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞, –¥—Ä—É–≥–æ–π —É–≥–æ–ª, 1 –≤–æ–ø—Ä–æ—Å –º–∞–∫—Å–∏–º—É–º. "
            f"Emotion={emo_state}."
        )

    def generate(self, *, profile: Dict[str, Any], history: List[dict], user_text: str) -> str:
        """
        –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞: –≤—ã–∑—ã–≤–∞–µ—Ç OpenAI, —Ä–µ—Ç—Ä–∞–∏, –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä, —á–µ–ª–æ–≤–µ–∫–æ–ø–æ–¥–æ–±–Ω—ã–π —Å—Ç–∏–ª—å.
        """
        client = self._client()
        msgs = self._build_messages(profile, history or [], user_text)

        last_err: Optional[Exception] = None
        temp = self._temperature(profile, user_text)

        for attempt in range(1, self.max_attempts + 1):
            try:
                resp = client.chat.completions.create(
                    model=self.model,
                    messages=msgs,
                    temperature=temp,
                )
                text_out = (resp.choices[0].message.content or "").strip()

                # –∞–Ω—Ç–∏-–∑–∞–ª–∏–ø–∞–Ω–∏–µ: –µ—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏–ª—Å—è ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ö–∏–Ω—Ç –∏ –¥–µ–ª–∞–µ–º 1 –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                if self._looks_like_repeat(history or [], text_out):
                    msgs.append({"role": "system", "content": self._anti_repeat_hint(profile, user_text)})
                    resp2 = client.chat.completions.create(
                        model=self.model,
                        messages=msgs,
                        temperature=min(0.90, temp + 0.06),
                    )
                    text_out = (resp2.choices[0].message.content or "").strip()

                if not text_out:
                    return (
                        "üß† –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç (–±—ã–≤–∞–µ—Ç üòÖ).\n"
                        "–ù–∞–ø–∏—à–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π:\n"
                        "–ò–≥—Ä–∞ | input | –≥–¥–µ —É–º–∏—Ä–∞–µ—à—å | —á—Ç–æ —Ö–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å."
                    )

                return text_out

            except Exception as e:
                last_err = e
                time.sleep(self.base_sleep * attempt)

        return (
            "üß† –ò–ò: ERROR (–ø–æ—Å–ª–µ —Ä–µ—Ç—Ä–∞–µ–≤)\n"
            f"{type(last_err).__name__}: {last_err}\n\n"
            "–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Render ‚Üí Environment:\n"
            "1) OPENAI_API_KEY = —Ç–≤–æ–π –∫–ª—é—á\n"
            "2) AI_ENABLED=1\n"
            "3) OPENAI_MODEL (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é gpt-4.1-mini)\n"
            "4) –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–æ–∫—Å–∏: OPENAI_BASE_URL\n\n"
            "–ï—Å–ª–∏ Render free ‚Äî —Å–µ—Ç—å –∏–Ω–æ–≥–¥–∞ —à–∞—Ç–∞–µ—Ç. –†–µ—Ç—Ä–∞–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã."
        )
